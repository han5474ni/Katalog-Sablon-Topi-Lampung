// Data wilayah Indonesia
const indonesiaData = {
    "Aceh": {
        "Banda Aceh": {
            "Baiturrahman": "23116",
            "Kuta Alam": "23126",
            "Meuraxa": "23236",
            "Syiah Kuala": "23111",
            "Ulee Kareng": "23119"
        },
        "Aceh Besar": {
            "Jantho": "23911",
            "Kuta Baro": "23361",
            "Lembah Seulawah": "23362"
        }
    },
    "Sumatera Utara": {
        "Medan": {
            "Medan Baru": "20232",
            "Medan Kota": "20214",
            "Medan Barat": "20117",
            "Medan Timur": "20231",
            "Medan Tembung": "20224"
        },
        "Deli Serdang": {
            "Lubuk Pakam": "20512",
            "Pancur Batu": "20353",
            "Sibolangit": "20355"
        }
    },
    "Sumatera Barat": {
        "Padang": {
            "Padang Barat": "25115",
            "Padang Timur": "25129",
            "Padang Utara": "25173",
            "Padang Selatan": "25144",
            "Koto Tangah": "25171"
        }
    },
    "Riau": {
        "Pekanbaru": {
            "Sukajadi": "28122",
            "Pekanbaru Kota": "28116",
            "Sail": "28283",
            "Senapelan": "28155"
        }
    },
    "Jambi": {
        "Jambi": {
            "Telanaipura": "36122",
            "Jambi Selatan": "36138",
            "Kotabaru": "36129",
            "Jelutung": "36124"
        }
    },
    "Sumatera Selatan": {
        "Palembang": {
            "Ilir Barat I": "30111",
            "Ilir Timur I": "30124",
            "Seberang Ulu I": "30252",
            "Bukit Kecil": "30119"
        }
    },
    "Bengkulu": {
        "Bengkulu": {
            "Teluk Segara": "38114",
            "Ratu Agung": "38222",
            "Singaran Pati": "38225"
        }
    },
    "Lampung": {
        "Bandar Lampung": {
            "Telukbetung Selatan": "35221",
            "Telukbetung Utara": "35222",
            "Telukbetung Barat": "35223",
            "Telukbetung Timur": "35224",
            "Panjang": "35241",
            "Tanjung Karang Pusat": "35211",
            "Tanjung Karang Barat": "35212",
            "Tanjung Karang Timur": "35213",
            "Tanjung Karang Selatan": "35214",
            "Kedaton": "35231",
            "Rajabasa": "35232",
            "Kemiling": "35151",
            "Labuhan Ratu": "35142",
            "Sukarame": "35131",
            "Sukabumi": "35122",
            "Langkapura": "35118",
            "Enggal": "35115",
            "Kedamaian": "35114",
            "Way Halim": "35132",
            "Bumi Waras": "35225"
        },
        "Lampung Selatan": {
            "Kalianda": "35551",
            "Rajabasa": "35552",
            "Candipuro": "35553",
            "Way Sulan": "35554",
            "Sidomulyo": "35555",
            "Ketapang": "35581",
            "Penengahan": "35582",
            "Natar": "35362",
            "Jati Agung": "35365",
            "Tanjung Bintang": "35361",
            "Katibung": "35591",
            "Merbau Mataram": "35592",
            "Palas": "35593",
            "Sragi": "35594",
            "Bakauheni": "35595"
        },
        "Lampung Tengah": {
            "Gunung Sugih": "34161",
            "Trimurjo": "34162",
            "Punggur": "34163",
            "Padang Ratu": "34164",
            "Seputih Raman": "34165",
            "Kalirejo": "34166",
            "Bandar Mataram": "34168",
            "Terbanggi Besar": "34169",
            "Way Pengubuan": "34171",
            "Seputih Mataram": "34172",
            "Rumbia": "34173",
            "Pubian": "34174",
            "Bandar Surabaya": "34175"
        },
        "Lampung Utara": {
            "Kotabumi": "34512",
            "Kotabumi Selatan": "34513",
            "Kotabumi Utara": "34514",
            "Abung Selatan": "34515",
            "Tanjung Raja": "34516",
            "Bunga Mayang": "34517",
            "Bukit Kemuning": "34518",
            "Abung Barat": "34519",
            "Abung Timur": "34521",
            "Sungkai Selatan": "34522",
            "Sungkai Utara": "34523",
            "Muara Sungkai": "34524",
            "Hulu Sungkai": "34525"
        },
        "Lampung Barat": {
            "Liwa": "34811",
            "Balik Bukit": "34812",
            "Sukau": "34813",
            "Suoh": "34814",
            "Sekincau": "34815",
            "Belalau": "34816",
            "Way Tenong": "34817",
            "Pagar Dewa": "34818",
            "Sumber Jaya": "34819",
            "Batu Brak": "34821",
            "Bandar Negeri Suoh": "34822",
            "Lumbok Seminung": "34823"
        },
        "Lampung Timur": {
            "Sukadana": "34381",
            "Labuhan Maringgai": "34382",
            "Jabung": "34383",
            "Pekalongan": "34384",
            "Sekampung": "34385",
            "Batanghari": "34386",
            "Way Jepara": "34387",
            "Purbolinggo": "34388",
            "Raman Utara": "34389",
            "Metro Kibang": "34391",
            "Marga Tiga": "34392",
            "Sekampung Udik": "34393",
            "Jabung Timur": "34394"
        },
        "Metro": {
            "Metro Pusat": "34111",
            "Metro Barat": "34112",
            "Metro Timur": "34113",
            "Metro Selatan": "34114",
            "Metro Utara": "34115"
        },
        "Pesawaran": {
            "Gedong Tataan": "35371",
            "Way Lima": "35372",
            "Negeri Katon": "35373",
            "Padang Cermin": "35374",
            "Punduh Pidada": "35375",
            "Way Ratai": "35376",
            "Marga Punduh": "35377",
            "Tegineneng": "35378",
            "Way Khilau": "35379",
            "Kedondong": "35381"
        },
        "Pringsewu": {
            "Pringsewu": "35719",
            "Gadingrejo": "35711",
            "Ambarawa": "35712",
            "Pagelaran": "35713",
            "Sukoharjo": "35714",
            "Banyumas": "35715",
            "Adiluwih": "35716",
            "Pardasuka": "35717",
            "Pagelaran Utara": "35718"
        },
        "Tanggamus": {
            "Kota Agung": "35711",
            "Talang Padang": "35712",
            "Wonosobo": "35713",
            "Gisting": "35714",
            "Semaka": "35715",
            "Pulau Panggung": "35716",
            "Kelumbayan": "35717",
            "Cukuh Balak": "35718",
            "Ulu Belu": "35719",
            "Bandar Negeri Semuong": "35721",
            "Limau": "35722",
            "Sumberejo": "35723"
        }
    },
    "DKI Jakarta": {
        "Jakarta Pusat": {
            "Gambir": "10110",
            "Tanah Abang": "10160",
            "Menteng": "10310",
            "Senen": "10410",
            "Cempaka Putih": "10510",
            "Johar Baru": "10560",
            "Kemayoran": "10610",
            "Sawah Besar": "10710"
        },
        "Jakarta Utara": {
            "Koja": "14210",
            "Kelapa Gading": "14240",
            "Tanjung Priok": "14310",
            "Pademangan": "14410",
            "Penjaringan": "14440",
            "Cilincing": "14120"
        },
        "Jakarta Barat": {
            "Cengkareng": "11730",
            "Grogol Petamburan": "11460",
            "Taman Sari": "11150",
            "Tambora": "11210",
            "Kebon Jeruk": "11530",
            "Kalideres": "11840",
            "Palmerah": "11410",
            "Kembangan": "11610"
        },
        "Jakarta Selatan": {
            "Kebayoran Baru": "12110",
            "Kebayoran Lama": "12210",
            "Pesanggrahan": "12270",
            "Cilandak": "12430",
            "Pasar Minggu": "12510",
            "Jagakarsa": "12620",
            "Mampang Prapatan": "12710",
            "Pancoran": "12780",
            "Tebet": "12810",
            "Setiabudi": "12910"
        },
        "Jakarta Timur": {
            "Matraman": "13110",
            "Pulo Gadung": "13210",
            "Jatinegara": "13310",
            "Duren Sawit": "13440",
            "Kramat Jati": "13510",
            "Makasar": "13570",
            "Pasar Rebo": "13710",
            "Ciracas": "13740",
            "Cipayung": "13840",
            "Cakung": "13910"
        }
    },
    "Banten": {
        "Tangerang": {
            "Tangerang": "15111",
            "Jatiuwung": "15134",
            "Batuceper": "15122",
            "Neglasari": "15129",
            "Ciledug": "15153"
        },
        "Tangerang Selatan": {
            "Serpong": "15310",
            "Ciputat": "15411",
            "Pondok Aren": "15224",
            "Pamulang": "15417"
        },
        "Serang": {
            "Serang": "42111",
            "Kasemen": "42191",
            "Walantaka": "42183",
            "Cipocok Jaya": "42122"
        }
    },
    "Jawa Barat": {
        "Bandung": {
            "Bandung Wetan": "40114",
            "Sumur Bandung": "40112",
            "Cicendo": "40172",
            "Sukajadi": "40162",
            "Coblong": "40132",
            "Antapani": "40291",
            "Arcamanik": "40293",
            "Ujungberung": "40611"
        },
        "Bekasi": {
            "Bekasi Barat": "17134",
            "Bekasi Timur": "17113",
            "Bekasi Utara": "17142",
            "Bekasi Selatan": "17144",
            "Rawalumbu": "17116"
        },
        "Bogor": {
            "Bogor Tengah": "16121",
            "Bogor Utara": "16152",
            "Bogor Selatan": "16132",
            "Bogor Timur": "16143",
            "Bogor Barat": "16116"
        },
        "Depok": {
            "Pancoran Mas": "16431",
            "Beji": "16421",
            "Sukmajaya": "16412",
            "Cimanggis": "16451"
        },
        "Cirebon": {
            "Kesambi": "45131",
            "Lemahwungkuk": "45111",
            "Pekalipan": "45118",
            "Harjamukti": "45143"
        }
    },
    "Jawa Tengah": {
        "Semarang": {
            "Semarang Tengah": "50132",
            "Semarang Utara": "50174",
            "Semarang Timur": "50125",
            "Semarang Selatan": "50149",
            "Candisari": "50254",
            "Gajahmungkur": "50232",
            "Tembalang": "50275"
        },
        "Solo": {
            "Laweyan": "57148",
            "Serengan": "57155",
            "Pasar Kliwon": "57118",
            "Jebres": "57126",
            "Banjarsari": "57133"
        },
        "Magelang": {
            "Magelang Utara": "56115",
            "Magelang Tengah": "56112",
            "Magelang Selatan": "56123"
        }
    },
    "DI Yogyakarta": {
        "Yogyakarta": {
            "Gondokusuman": "55223",
            "Jetis": "55233",
            "Danurejan": "55211",
            "Gedongtengen": "55122",
            "Ngampilan": "55261",
            "Kraton": "55131",
            "Gondomanan": "55122"
        },
        "Sleman": {
            "Depok": "55281",
            "Mlati": "55288",
            "Ngaglik": "55581",
            "Sleman": "55515"
        },
        "Bantul": {
            "Bantul": "55711",
            "Sewon": "55185",
            "Kasihan": "55181"
        }
    },
    "Jawa Timur": {
        "Surabaya": {
            "Surabaya Pusat": "60271",
            "Surabaya Utara": "60177",
            "Surabaya Timur": "60112",
            "Surabaya Selatan": "60225",
            "Gubeng": "60281",
            "Tegalsari": "60262",
            "Genteng": "60275"
        },
        "Malang": {
            "Klojen": "65111",
            "Blimbing": "65126",
            "Kedungkandang": "65136",
            "Lowokwaru": "65141",
            "Sukun": "65147"
        },
        "Sidoarjo": {
            "Sidoarjo": "61213",
            "Buduran": "61252",
            "Candi": "61271",
            "Gedangan": "61254"
        }
    },
    "Bali": {
        "Denpasar": {
            "Denpasar Selatan": "80221",
            "Denpasar Timur": "80237",
            "Denpasar Barat": "80119",
            "Denpasar Utara": "80116"
        },
        "Badung": {
            "Kuta": "80361",
            "Mengwi": "80351",
            "Abiansemal": "80352"
        }
    },
    "Nusa Tenggara Barat": {
        "Mataram": {
            "Ampenan": "83511",
            "Mataram": "83115",
            "Cakranegara": "83231",
            "Sekarbela": "83114"
        }
    },
    "Nusa Tenggara Timur": {
        "Kupang": {
            "Kupang Tengah": "85119",
            "Kelapa Lima": "85228",
            "Oebobo": "85228"
        }
    },
    "Kalimantan Barat": {
        "Pontianak": {
            "Pontianak Kota": "78113",
            "Pontianak Barat": "78243",
            "Pontianak Selatan": "78114",
            "Pontianak Timur": "78121"
        }
    },
    "Kalimantan Tengah": {
        "Palangkaraya": {
            "Pahandut": "73111",
            "Jekan Raya": "73111",
            "Bukit Batu": "73112"
        }
    },
    "Kalimantan Selatan": {
        "Banjarmasin": {
            "Banjarmasin Tengah": "70111",
            "Banjarmasin Barat": "70119",
            "Banjarmasin Timur": "70236",
            "Banjarmasin Selatan": "70249",
            "Banjarmasin Utara": "70124"
        }
    },
    "Kalimantan Timur": {
        "Samarinda": {
            "Samarinda Ulu": "75122",
            "Samarinda Ilir": "75112",
            "Samarinda Utara": "75126",
            "Sungai Kunjang": "75243"
        },
        "Balikpapan": {
            "Balikpapan Timur": "76116",
            "Balikpapan Barat": "76132",
            "Balikpapan Selatan": "76114",
            "Balikpapan Utara": "76127"
        }
    },
    "Sulawesi Utara": {
        "Manado": {
            "Malalayang": "95163",
            "Sario": "95115",
            "Wenang": "95111",
            "Tikala": "95122"
        }
    },
    "Sulawesi Tengah": {
        "Palu": {
            "Palu Barat": "94111",
            "Palu Timur": "94237",
            "Palu Selatan": "94221",
            "Palu Utara": "94224"
        }
    },
    "Sulawesi Selatan": {
        "Makassar": {
            "Makassar": "90111",
            "Ujung Pandang": "90112",
            "Mamajang": "90135",
            "Tamalate": "90221",
            "Panakkukang": "90231",
            "Biringkanaya": "90241"
        }
    },
    "Sulawesi Tenggara": {
        "Kendari": {
            "Kendari": "93111",
            "Mandonga": "93232",
            "Baruga": "93563"
        }
    },
    "Maluku": {
        "Ambon": {
            "Sirimau": "97124",
            "Nusaniwe": "97115",
            "Baguala": "97233"
        }
    },
    "Papua": {
        "Jayapura": {
            "Jayapura Selatan": "99224",
            "Jayapura Utara": "99112",
            "Abepura": "99351"
        }
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const provinceSelect = document.getElementById('province');
    const citySelect = document.getElementById('city');
    const districtSelect = document.getElementById('district');
    const postalCodeInput = document.getElementById('postal_code');

    // Populate provinces
    Object.keys(indonesiaData).forEach(province => {
        const option = document.createElement('option');
        option.value = province;
        option.textContent = province;
        provinceSelect.appendChild(option);
    });

    // Province change handler
    provinceSelect.addEventListener('change', function() {
        const selectedProvince = this.value;
        
        // Reset dependent fields
        citySelect.innerHTML = '<option value="">Pilih Kota/Kabupaten</option>';
        districtSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
        postalCodeInput.value = '';
        
        citySelect.disabled = !selectedProvince;
        districtSelect.disabled = true;
        
        if (selectedProvince && indonesiaData[selectedProvince]) {
            // Populate cities
            Object.keys(indonesiaData[selectedProvince]).forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
    });

    // City change handler
    citySelect.addEventListener('change', function() {
        const selectedProvince = provinceSelect.value;
        const selectedCity = this.value;
        
        // Reset dependent fields
        districtSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
        postalCodeInput.value = '';
        
        districtSelect.disabled = !selectedCity;
        
        if (selectedProvince && selectedCity && indonesiaData[selectedProvince][selectedCity]) {
            // Populate districts
            Object.keys(indonesiaData[selectedProvince][selectedCity]).forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
    });

    // District change handler
    districtSelect.addEventListener('change', function() {
        const selectedProvince = provinceSelect.value;
        const selectedCity = citySelect.value;
        const selectedDistrict = this.value;
        
        postalCodeInput.value = '';
        
        if (selectedProvince && selectedCity && selectedDistrict) {
            const postalCode = indonesiaData[selectedProvince][selectedCity][selectedDistrict];
            if (postalCode) {
                postalCodeInput.value = postalCode;
            }
        }
    });

    // Load existing data if editing
    const currentProvince = provinceSelect.dataset.current;
    const currentCity = citySelect.dataset.current;
    const currentDistrict = districtSelect.dataset.current;

    if (currentProvince) {
        provinceSelect.value = currentProvince;
        provinceSelect.dispatchEvent(new Event('change'));
        
        setTimeout(() => {
            if (currentCity) {
                citySelect.value = currentCity;
                citySelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    if (currentDistrict) {
                        districtSelect.value = currentDistrict;
                        districtSelect.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }
        }, 100);
    }

    // Profile form submission (Basic Info)
    const profileForm = document.getElementById('profile-form');
    const addressForm = document.getElementById('address-form');
    
    // Combine both forms for submission
    if (profileForm && addressForm) {
        const submitProfile = async (e) => {
            e.preventDefault();
            
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            // Combine data from both forms
            const formData = new FormData();
            formData.append('_token', document.querySelector('meta[name="csrf-token"]').content);
            formData.append('name', document.getElementById('name').value);
            formData.append('email', document.getElementById('email').value);
            formData.append('phone', document.getElementById('phone').value || '');
            formData.append('address', document.getElementById('address').value);
            formData.append('province', document.getElementById('province').value);
            formData.append('city', document.getElementById('city').value);
            formData.append('district', document.getElementById('district').value);
            formData.append('postal_code', document.getElementById('postal_code').value);
            
            try {
                const response = await fetch('/profile', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Profile berhasil diperbarui!');
                    window.location.reload();
                } else {
                    alert('Gagal memperbarui profile: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memperbarui profile');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };
        
        // Add submit handlers to both forms
        addressForm.addEventListener('submit', submitProfile);
    }

    // Password form submission
    const passwordForm = document.getElementById('password-form');
    if (passwordForm) {
        passwordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const loadingOverlay = document.getElementById('loading-overlay');
            
            loadingOverlay.style.display = 'flex';
            
            try {
                const response = await fetch('/profile/password', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Password berhasil diubah!');
                    this.reset();
                } else {
                    alert('Gagal mengubah password: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengubah password');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });
    }

    // Avatar upload
    const avatarInput = document.getElementById('avatar-input');
    if (avatarInput) {
        avatarInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('avatar', file);
            
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const response = await fetch('/profile/avatar', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('avatar-preview').src = data.avatar_url;
                    alert('Avatar berhasil diperbarui!');
                    window.location.reload();
                } else {
                    alert('Gagal upload avatar: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat upload avatar');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });
    }

    // Delete avatar
    const deleteAvatarBtn = document.getElementById('delete-avatar-btn');
    if (deleteAvatarBtn) {
        deleteAvatarBtn.addEventListener('click', async function() {
            if (!confirm('Yakin ingin menghapus foto profil?')) return;
            
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const response = await fetch('/profile/avatar', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Avatar berhasil dihapus!');
                    window.location.reload();
                } else {
                    alert('Gagal menghapus avatar: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus avatar');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });
    }
});
